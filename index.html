<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ticket 58mm</title>
  <style>
    @page {
      size: 58mm auto;
      margin: 2mm;
    }
    body {
      font-family: Tahoma, Helvetica, sans-serif;
      font-size: 3.6mm; /* un poco más pequeño que antes */
      margin: 0;
      color: black;
    }
    .ticket {
      width: 100%;
      box-sizing: border-box;
    }
    .center { text-align: center; }
    .right { text-align: right; }
    h1 {
      font-size: 5.5mm; 
      margin: 2mm 0 1mm 0;
      text-align: center;
    }
    h2 {
      font-size: 4.8mm;
      margin: 0;
      text-align: center;
    }
    h3 {
      font-size: 4.2mm;
      margin: 1mm 0 3mm 0;
      text-align: center;
    }
    .data {
      margin: 1mm 0;
      font-size: 3.6mm;
    }
    .bold { font-weight: bold; }
    .ticket-num {
      text-align: center;
      font-size: 5.5mm;
      font-weight: bold;
      margin: 2mm 0;
    }
    .mesa {
      text-align: center;
      font-size: 5.5mm;
      font-weight: bold;
      margin: 2mm 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2mm;
    }
    th, td {
      font-size: 3.6mm;
      padding: 0.5mm 0;
    }
    th {
      border-bottom: 1px dashed black;
      text-align: center;
    }
    .totales {
      width: 100%;
      font-size: 4mm;
      border-top: 1px dashed black;
      margin-top: 3mm;
      font-weight: bold;
    }
    .totales td {
      padding: 0.5mm 0;
    }
    .total-grande {
      font-size: 4.8mm;
      font-weight: bold;
    }
    .policy {
      margin-top: 4mm;
      text-align: center;
      font-size: 3mm;
      line-height: 1.4;
    }
  </style>
</head>
<body onload="window.print()" onfocus="window.close()">

<div class="ticket">
  <h1>EL RAPIDIN</h1>
  <h2>Caldos - Chifa - Broaster</h2>
  <h3>San Martín de Pangoa</h3>

  <!-- Ticket centrado -->
  <div class="ticket-num">
    TICKET<br>
    <span id="nro_boleta_id"></span>
  </div>

  <!-- Cliente -->
  <p class="data"><b>Cliente:</b> <span id="cliente_id"></span></p>

  <!-- Mesa centrada -->
  <div class="mesa" id="nro_mesa_id"></div>

  <p class="data" id="nro_direccion_id"></p>

  <!-- Línea con F/H enviado desde AppSheet (comentada) -->
  <!-- <p class="data"><b>F/H:</b> <span id="fechaR"></span></p> -->

  <!-- Nueva línea con fecha/hora de impresión -->
  <p class="data"><b>F/H Impresión:</b> <span id="fecha_impresion"></span></p>

  <table>
    <thead>
      <tr>
        <th>Cant</th>
        <th>Descripción</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody id="tablaBody"></tbody>
  </table>

  <table class="totales">
    <tbody>
      <tr>
        <td class="total-grande">TOTAL:</td>
        <td class="right total-grande" id="total"></td>
      </tr>
      <tr>
        <td>CANCELA:</td>
        <td class="right" id="efectivo"></td>
      </tr>
      <tr>
        <td>VUELTO:</td>
        <td class="right" id="devueltas"></td>
      </tr>
      <tr>
        <td>PAGO:</td>
        <td class="right" id="estado"></td>
      </tr>
    </tbody>
  </table>

  <div class="policy">
    * Comprobante solo informativo no sustituye boleta ni factura *<br>
    ¡Gracias por su preferencia!
  </div>
</div>

<script>
  const params = new URLSearchParams(window.location.search);

  function parseList(param) {
    let val = (param || "").replace(/[{}]/g, "").replace(/\s+/g, "");
    return val ? val.split(",") : [];
  }

  // Datos desde AppSheet
  var nro_boleta = params.get("boleta");
  var nro_mesa = params.get("mesa");
  var cliente = params.get("cliente");
  var direc = params.get("direccion");
  // var fecha = params.get("fecha"); // si deseas usarlo
  // var hora = params.get("fecha_entrega"); // si deseas usarlo

  var total = parseFloat(params.get("total") || 0);
  var efectivo = parseFloat(params.get("pago") || 0);
  var vuelto = parseFloat(params.get("vuelto") || 0);
  var estado = params.get("estado");

  const cantidades = parseList(params.get("cantidades"));
  const servicios = parseList(params.get("servicios"));
  const precios = parseList(params.get("p_unit"));

  // Render en ticket
  document.getElementById("nro_boleta_id").textContent = nro_boleta || "";
  document.getElementById("nro_mesa_id").textContent = nro_mesa || "";
  document.getElementById("cliente_id").textContent = cliente || "";
  document.getElementById("nro_direccion_id").textContent = direc || "";
  // document.getElementById("fechaR").textContent = fecha + " " + hora; // opcional

  document.getElementById("total").textContent = total ? total.toFixed(2) : "";
  document.getElementById("efectivo").textContent = efectivo ? efectivo.toFixed(2) : "";
  document.getElementById("devueltas").textContent = vuelto ? vuelto.toFixed(2) : "";
  document.getElementById("estado").textContent = estado || "";

  // F/H Impresión en tiempo real
  const ahora = new Date();
  const fechaHoy = ahora.toLocaleDateString("es-PE");
  const horaHoy = ahora.toLocaleTimeString("es-PE");
  document.getElementById("fecha_impresion").textContent = fechaHoy + " " + horaHoy;

  // Generar tabla de productos
  const tablaBody = document.getElementById("tablaBody");
  servicios.forEach((serv, i) => {
    if (serv.trim() !== "") {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${cantidades[i] || ""}</td>
        <td>${serv}</td>
        <td class="right">${Number(precios[i] || 0).toFixed(2)}</td>
      `;
      tablaBody.appendChild(row);
    }
  });
</script>

</body>
</html>
